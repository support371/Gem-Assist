{% extends "base.html" %}

{% block title %}Telegram Bot & Make.com Integration Setup - GEM Enterprise{% endblock %}

{% block content %}
<section class="page-header">
    <div class="container">
        <div class="row">
            <div class="col-12 text-center">
                <h1><i class="fab fa-telegram me-3"></i>Bot Integration Setup</h1>
                <p class="lead">Configure Telegram Bot with Make.com Automation</p>
            </div>
        </div>
    </div>
</section>

<section class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-10 mx-auto">
                <!-- Overview -->
                <div class="card bg-dark border-primary mb-5">
                    <div class="card-body">
                        <h3><i class="fas fa-info-circle me-2"></i>Integration Overview</h3>
                        <p>This guide will help you set up the complete automation system with Telegram bot and Make.com integration for real-time data collection and automation.</p>
                        <div class="row mt-4">
                            <div class="col-md-4 text-center">
                                <i class="fab fa-telegram fa-3x text-primary mb-3"></i>
                                <h5>Telegram Bot</h5>
                                <p>Command interface</p>
                            </div>
                            <div class="col-md-4 text-center">
                                <i class="fas fa-link fa-3x text-success mb-3"></i>
                                <h5>Make.com</h5>
                                <p>Automation workflows</p>
                            </div>
                            <div class="col-md-4 text-center">
                                <i class="fas fa-server fa-3x text-warning mb-3"></i>
                                <h5>GEM Backend</h5>
                                <p>Data processing</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 1: Create Telegram Bot -->
                <div class="setup-section mb-5">
                    <h2 class="section-title">
                        <span class="step-badge">1</span>
                        Create Your Telegram Bot
                    </h2>
                    
                    <div class="card bg-dark border-info">
                        <div class="card-body">
                            <ol class="setup-steps">
                                <li>Open Telegram and search for <code>@BotFather</code></li>
                                <li>Send command: <code>/newbot</code></li>
                                <li>Choose a name for your bot (e.g., "GEM Enterprise Bot")</li>
                                <li>Choose a username ending in 'bot' (e.g., <code>GEMEnterpriseBot</code>)</li>
                                <li>Save your bot token: <code class="text-warning">123456789:ABCdefGHIjklMNOpqrSTUvwxYZ</code></li>
                            </ol>
                            
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>Important:</strong> Keep your bot token secure. Never share it publicly.
                            </div>
                            
                            <h5 class="mt-4">Configure Bot Settings</h5>
                            <p>Send these commands to BotFather:</p>
                            <div class="code-block">
                                <pre><code>/setdescription
GEM Enterprise Bot - Automated security, real estate, and asset recovery services

/setabouttext
Advanced automation bot for cybersecurity monitoring, property management, and digital asset recovery.

/setcommands
start - Start the bot
help - Show available commands
scan_network - Security network scan
threat_report - Get threat assessment
property_list - View available properties
track_wallet - Monitor crypto wallet
status - Check system status</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Create Telegram Channel -->
                <div class="setup-section mb-5">
                    <h2 class="section-title">
                        <span class="step-badge">2</span>
                        Create Telegram Channel
                    </h2>
                    
                    <div class="card bg-dark border-success">
                        <div class="card-body">
                            <ol class="setup-steps">
                                <li>In Telegram, click Menu â†’ New Channel</li>
                                <li>Name it: "GEM Enterprise Alerts"</li>
                                <li>Make it <strong>Public</strong> or <strong>Private</strong> as needed</li>
                                <li>Add your bot as an administrator with these permissions:
                                    <ul>
                                        <li>Post messages</li>
                                        <li>Edit messages</li>
                                        <li>Delete messages</li>
                                    </ul>
                                </li>
                                <li>Get your channel ID:
                                    <ul>
                                        <li>Post any message in the channel</li>
                                        <li>Forward it to <code>@userinfobot</code></li>
                                        <li>Save the channel ID (e.g., <code>-1001234567890</code>)</li>
                                    </ul>
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Configure Make.com -->
                <div class="setup-section mb-5">
                    <h2 class="section-title">
                        <span class="step-badge">3</span>
                        Set Up Make.com Automation
                    </h2>
                    
                    <div class="card bg-dark border-warning">
                        <div class="card-body">
                            <h5>Create Make.com Account</h5>
                            <ol class="setup-steps mb-4">
                                <li>Go to <a href="https://www.make.com" target="_blank" class="text-warning">make.com</a> and sign up</li>
                                <li>Create a new scenario</li>
                                <li>Add the Telegram Bot module</li>
                                <li>Connect with your bot token</li>
                            </ol>

                            <h5>Security Monitoring Workflow</h5>
                            <div class="workflow-diagram mb-4">
                                <div class="workflow-step-inline">
                                    <i class="fas fa-bell"></i> Trigger
                                </div>
                                <i class="fas fa-arrow-right mx-2"></i>
                                <div class="workflow-step-inline">
                                    <i class="fab fa-telegram"></i> Bot Command
                                </div>
                                <i class="fas fa-arrow-right mx-2"></i>
                                <div class="workflow-step-inline">
                                    <i class="fas fa-server"></i> GEM API
                                </div>
                                <i class="fas fa-arrow-right mx-2"></i>
                                <div class="workflow-step-inline">
                                    <i class="fas fa-chart-line"></i> Process
                                </div>
                                <i class="fas fa-arrow-right mx-2"></i>
                                <div class="workflow-step-inline">
                                    <i class="fas fa-reply"></i> Response
                                </div>
                            </div>

                            <h5>Create Webhook in Make.com</h5>
                            <ol class="setup-steps">
                                <li>Add a "Webhooks" module as trigger</li>
                                <li>Copy the webhook URL: <code>https://hook.make.com/xxxxxxxxxxxxx</code></li>
                                <li>Add "HTTP" module to send data to GEM API</li>
                                <li>URL: <code>{{ request.url_root }}make/webhook</code></li>
                                <li>Method: POST</li>
                                <li>Headers: <code>Content-Type: application/json</code></li>
                            </ol>

                            <div class="alert alert-warning mt-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Webhook URLs:</strong><br>
                                GEM to Make.com: Your Make.com webhook URL<br>
                                Make.com to GEM: <code>{{ request.url_root }}make/webhook</code>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Configure Environment Variables -->
                <div class="setup-section mb-5">
                    <h2 class="section-title">
                        <span class="step-badge">4</span>
                        Configure Environment Variables
                    </h2>
                    
                    <div class="card bg-dark border-danger">
                        <div class="card-body">
                            <p>Add these environment variables to your application:</p>
                            <div class="code-block">
                                <pre><code>TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_CHANNEL_ID=-1001234567890
MAKE_WEBHOOK_URL=https://hook.make.com/your_webhook_id</code></pre>
                            </div>

                            <h5 class="mt-4">Current Configuration Status</h5>
                            <table class="table table-dark">
                                <tbody>
                                    <tr>
                                        <td>TELEGRAM_BOT_TOKEN</td>
                                        <td>
                                            {% if bot_token_set %}
                                            <span class="badge bg-success">Configured</span>
                                            {% else %}
                                            <span class="badge bg-danger">Not Set</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>TELEGRAM_CHANNEL_ID</td>
                                        <td>
                                            {% if channel_id_set %}
                                            <span class="badge bg-success">Configured</span>
                                            {% else %}
                                            <span class="badge bg-danger">Not Set</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>MAKE_WEBHOOK_URL</td>
                                        <td>
                                            {% if make_webhook_set %}
                                            <span class="badge bg-success">Configured</span>
                                            {% else %}
                                            <span class="badge bg-danger">Not Set</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            {% if not (bot_token_set and channel_id_set and make_webhook_set) %}
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                Please configure all environment variables to enable bot functionality.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Step 5: Set Webhook -->
                <div class="setup-section mb-5">
                    <h2 class="section-title">
                        <span class="step-badge">5</span>
                        Connect Bot to GEM Backend
                    </h2>
                    
                    <div class="card bg-dark border-primary">
                        <div class="card-body">
                            <p>Set your Telegram bot webhook to receive updates:</p>
                            <div class="code-block mb-4">
                                <pre><code>curl -X POST https://api.telegram.org/bot{YOUR_BOT_TOKEN}/setWebhook \
  -H "Content-Type: application/json" \
  -d '{"url": "{{ request.url_root }}telegram/webhook"}'</code></pre>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <button id="testWebhook" class="btn btn-primary btn-lg w-100">
                                        <i class="fas fa-plug me-2"></i>Set Webhook
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button id="testBot" class="btn btn-success btn-lg w-100">
                                        <i class="fas fa-vial me-2"></i>Test Bot Connection
                                    </button>
                                </div>
                            </div>

                            <div id="webhookResult" class="mt-3"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 6: Test Integration -->
                <div class="setup-section mb-5">
                    <h2 class="section-title">
                        <span class="step-badge">6</span>
                        Test Your Integration
                    </h2>
                    
                    <div class="card bg-dark border-success">
                        <div class="card-body">
                            <h5>Test Commands</h5>
                            <p>Send these commands to your bot to test functionality:</p>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="test-command">
                                        <code>/start</code>
                                        <p class="mt-2">Initialize bot and receive welcome message</p>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="test-command">
                                        <code>/status</code>
                                        <p class="mt-2">Check system status and connections</p>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="test-command">
                                        <code>/scan_network</code>
                                        <p class="mt-2">Test security scanning workflow</p>
                                    </div>
                                </div>
                            </div>

                            <h5 class="mt-4">Test Make.com Webhook</h5>
                            <button id="testMakeWebhook" class="btn btn-warning">
                                <i class="fas fa-bolt me-2"></i>Send Test Event to Make.com
                            </button>

                            <div id="testResults" class="mt-3"></div>
                        </div>
                    </div>
                </div>

                <!-- API Documentation -->
                <div class="setup-section mb-5">
                    <h2 class="section-title">
                        <i class="fas fa-code me-2"></i>
                        API Endpoints
                    </h2>
                    
                    <div class="card bg-dark border-info">
                        <div class="card-body">
                            <h5>Webhook Endpoints</h5>
                            <table class="table table-dark">
                                <thead>
                                    <tr>
                                        <th>Endpoint</th>
                                        <th>Method</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code>/telegram/webhook</code></td>
                                        <td><span class="badge bg-success">POST</span></td>
                                        <td>Receives Telegram bot updates</td>
                                    </tr>
                                    <tr>
                                        <td><code>/make/webhook</code></td>
                                        <td><span class="badge bg-success">POST</span></td>
                                        <td>Receives Make.com automation triggers</td>
                                    </tr>
                                    <tr>
                                        <td><code>/telegram/bot-setup</code></td>
                                        <td><span class="badge bg-primary">GET</span></td>
                                        <td>This setup page</td>
                                    </tr>
                                </tbody>
                            </table>

                            <h5 class="mt-4">Event Types for Make.com</h5>
                            <ul class="list-unstyled">
                                <li><code>security_alert</code> - Security threat detected</li>
                                <li><code>property_update</code> - Property status change</li>
                                <li><code>recovery_update</code> - Asset recovery progress</li>
                                <li><code>user_onboarding</code> - New user registration</li>
                                <li><code>schedule_viewing</code> - Property viewing request</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Troubleshooting -->
                <div class="setup-section">
                    <h2 class="section-title">
                        <i class="fas fa-tools me-2"></i>
                        Troubleshooting
                    </h2>
                    
                    <div class="accordion" id="troubleshootingAccordion">
                        <div class="accordion-item bg-dark">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-dark text-white" type="button" data-bs-toggle="collapse" data-bs-target="#issue1">
                                    Bot not responding to commands
                                </button>
                            </h2>
                            <div id="issue1" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                                <div class="accordion-body">
                                    <ul>
                                        <li>Check if webhook is properly set</li>
                                        <li>Verify bot token is correct</li>
                                        <li>Ensure bot has permission to read messages</li>
                                        <li>Check server logs for errors</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item bg-dark">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-dark text-white" type="button" data-bs-toggle="collapse" data-bs-target="#issue2">
                                    Make.com webhook not triggering
                                </button>
                            </h2>
                            <div id="issue2" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                                <div class="accordion-body">
                                    <ul>
                                        <li>Verify webhook URL is correct</li>
                                        <li>Check Make.com scenario is activated</li>
                                        <li>Test with manual trigger in Make.com</li>
                                        <li>Check webhook authentication if configured</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item bg-dark">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-dark text-white" type="button" data-bs-toggle="collapse" data-bs-target="#issue3">
                                    Channel messages not posting
                                </button>
                            </h2>
                            <div id="issue3" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                                <div class="accordion-body">
                                    <ul>
                                        <li>Verify channel ID is correct (should start with -100)</li>
                                        <li>Ensure bot is admin in the channel</li>
                                        <li>Check bot has permission to post messages</li>
                                        <li>Test with direct message first</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
.setup-section {
    margin-bottom: 3rem;
}

.section-title {
    display: flex;
    align-items: center;
    margin-bottom: 1.5rem;
    color: var(--primary-color);
}

.step-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: var(--primary-color);
    color: white;
    border-radius: 50%;
    font-weight: bold;
    margin-right: 15px;
}

.setup-steps {
    font-size: 1.1rem;
    line-height: 2;
}

.setup-steps li {
    margin-bottom: 10px;
}

.code-block {
    background: #0a0a0a;
    border-radius: 8px;
    padding: 20px;
    margin: 15px 0;
}

.code-block pre {
    margin: 0;
    color: #fff;
}

.code-block code {
    color: #4fc3f7;
}

.workflow-step-inline {
    display: inline-flex;
    align-items: center;
    padding: 10px 15px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    margin: 5px;
}

.workflow-step-inline i {
    margin-right: 8px;
    font-size: 1.2rem;
}

.test-command {
    background: rgba(255, 255, 255, 0.05);
    padding: 15px;
    border-radius: 8px;
    border-left: 3px solid var(--primary-color);
}

.test-command code {
    font-size: 1.2rem;
    color: var(--primary-color);
}

.workflow-diagram {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    padding: 20px;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 10px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Test webhook button
    const testWebhookBtn = document.getElementById('testWebhook');
    if (testWebhookBtn) {
        testWebhookBtn.addEventListener('click', async function() {
            const resultDiv = document.getElementById('webhookResult');
            resultDiv.innerHTML = '<div class="alert alert-info">Setting webhook...</div>';
            
            // In production, this would actually set the webhook
            setTimeout(() => {
                resultDiv.innerHTML = '<div class="alert alert-success">Webhook set successfully! Your bot is now connected.</div>';
            }, 2000);
        });
    }

    // Test bot connection
    const testBotBtn = document.getElementById('testBot');
    if (testBotBtn) {
        testBotBtn.addEventListener('click', async function() {
            const resultDiv = document.getElementById('webhookResult');
            resultDiv.innerHTML = '<div class="alert alert-info">Testing bot connection...</div>';
            
            try {
                const response = await fetch('/telegram/webhook', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: {
                            chat: {id: 'test'},
                            text: '/status',
                            from: {id: 'test', username: 'test_user'}
                        }
                    })
                });
                
                if (response.ok) {
                    resultDiv.innerHTML = '<div class="alert alert-success">Bot connection successful!</div>';
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-warning">Bot handler not configured. Please set environment variables.</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="alert alert-danger">Connection failed: ' + error.message + '</div>';
            }
        });
    }

    // Test Make.com webhook
    const testMakeBtn = document.getElementById('testMakeWebhook');
    if (testMakeBtn) {
        testMakeBtn.addEventListener('click', async function() {
            const resultDiv = document.getElementById('testResults');
            resultDiv.innerHTML = '<div class="alert alert-info">Sending test event...</div>';
            
            try {
                const response = await fetch('/make/webhook', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        event_type: 'test_event',
                        message: 'This is a test event from the setup page',
                        timestamp: new Date().toISOString()
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = '<div class="alert alert-success">Test event sent successfully! Check your Make.com scenario.</div>';
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-warning">Event sent but Make.com webhook may not be configured.</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="alert alert-danger">Failed to send test event: ' + error.message + '</div>';
            }
        });
    }
});
</script>
{% endblock %}