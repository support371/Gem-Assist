import twilio from "twilio";
import dotenv from "dotenv";
import axios from "axios";

dotenv.config();

// === Twilio Client ===
const client = twilio(process.env.TWILIO_ACCOUNT_SID, process.env.TWILIO_AUTH_TOKEN);

// === Test Configuration ===
const TEST_NUMBER = "+YOUR_PERSONAL_NUMBER"; // Replace with your phone number
const TEST_MESSAGE = "Twilio Full Test Message from Infinite Abundance LLC";
const WEBHOOK_URL = process.env.TWILIO_WEBHOOK_URL || "http://localhost:3000/twilio-webhook";

async function testSMS() {
  try {
    const msg = await client.messages.create({
      body: TEST_MESSAGE,
      from: process.env.TWILIO_PHONE_NUMBER,
      to: TEST_NUMBER
    });
    console.log("✅ SMS sent successfully:", msg.sid);
  } catch (err) {
    console.error("❌ SMS test failed:", err.message);
  }
}

async function testWhatsApp() {
  try {
    const msg = await client.messages.create({
      body: TEST_MESSAGE,
      from: "whatsapp:" + process.env.TWILIO_PHONE_NUMBER,
      to: "whatsapp:" + TEST_NUMBER
    });
    console.log("✅ WhatsApp sent successfully:", msg.sid);
  } catch (err) {
    console.error("❌ WhatsApp test failed:", err.message);
  }
}

async function testVoice() {
  try {
    const call = await client.calls.create({
      url: "http://demo.twilio.com/docs/voice.xml",
      to: TEST_NUMBER,
      from: process.env.TWILIO_PHONE_NUMBER
    });
    console.log("✅ Voice call initiated:", call.sid);
  } catch (err) {
    console.error("❌ Voice call test failed:", err.message);
  }
}

async function testOTP() {
  try {
    const verification = await client.verify.v2
      .services(process.env.TWILIO_VERIFY_SERVICE_SID)
      .verifications.create({ to: TEST_NUMBER, channel: "sms" });
    console.log("✅ OTP sent:", verification.status);
  } catch (err) {
    console.error("❌ OTP test failed:", err.message);
  }
}

async function testInboundWebhook() {
  try {
    // Send a test request to your webhook to simulate inbound SMS/Call
    const response = await axios.post(WEBHOOK_URL, {
      From: TEST_NUMBER,
      Body: "Inbound Test Message",
      To: process.env.TWILIO_PHONE_NUMBER
    });
    console.log("✅ Inbound webhook test response status:", response.status);
    console.log("Response data:", response.data);
  } catch (err) {
    console.error("❌ Inbound webhook test failed:", err.message);
  }
}

async function runAllTests() {
  console.log("=== Starting Full Twilio Number Two-Way Test ===");
  await testSMS();
  await testWhatsApp();
  await testVoice();
  await testOTP();
  await testInboundWebhook();
  console.log("=== Full Test Completed ===");
}

runAllTests();
